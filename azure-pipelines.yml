trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  TF_VERSION: "1.7.5"
  TF_WORKING_DIR: "$(System.DefaultWorkingDirectory)"

stages:
- stage: ValidateAndPlan
  displayName: "Terraform Validate & Plan"
  jobs:
  - job: plan
    pool:
      vmImage: "windows-latest"
    steps:
    - checkout: self
      fetchDepth: 0

    # Login to Azure using the service connection
    - task: AzureCLI@2
      displayName: "Az login (service connection)"
      inputs:
        azureSubscription: "sc-terraform-sub"
        scriptType: pscore
        scriptLocation: inlineScript
        inlineScript: |
          az account show

    # Install Terraform
    - task: PowerShell@2
      displayName: "Install Terraform $(TF_VERSION)"
      inputs:
        targetType: inline
        script: |
          $v = "$(TF_VERSION)"
          $zip = "$env:Agent_TempDirectory\terraform.zip"
          Invoke-WebRequest "https://releases.hashicorp.com/terraform/$v/terraform_${v}_windows_amd64.zip" -OutFile $zip
          Expand-Archive $zip -DestinationPath "$env:Agent_TempDirectory" -Force
          Copy-Item "$env:Agent_TempDirectory\terraform.exe" "$env:ProgramFiles\terraform\terraform.exe" -Force -ErrorAction SilentlyContinue
          $env:PATH = "$env:ProgramFiles\terraform;$env:PATH"
          terraform -version

    # Terraform init/validate/plan (uses Azure CLI auth from the same agent)
    - task: AzureCLI@2
      displayName: "Terraform init/validate/plan"
      inputs:
        azureSubscription: "sc-terraform-sub"
        scriptType: pscore
        scriptLocation: inlineScript
        workingDirectory: "$(TF_WORKING_DIR)"
        inlineScript: |
          $env:PATH = "$env:ProgramFiles\terraform;$env:PATH"
          terraform -version
          terraform init -upgrade -input=false
          terraform validate
          terraform plan -out=tfplan -input=false
          terraform show -no-color tfplan > tfplan.txt

    - publish: "$(TF_WORKING_DIR)/tfplan"
      artifact: tfplan-bin
    - publish: "$(TF_WORKING_DIR)/tfplan.txt"
      artifact: tfplan-text

- stage: Apply
  displayName: "Terraform Apply (Build Image + Auto Cleanup)"
  dependsOn: ValidateAndPlan
  jobs:
  - job: apply
    pool:
      vmImage: "windows-latest"
    steps:
    - checkout: self

    - download: current
      artifact: tfplan-bin

    - task: AzureCLI@2
      displayName: "Terraform init (reconfigure) & apply"
      inputs:
        azureSubscription: "sc-terraform-sub"
        scriptType: pscore
        scriptLocation: inlineScript
        workingDirectory: "$(System.DefaultWorkingDirectory)"
        inlineScript: |
          $env:PATH = "$env:ProgramFiles\terraform;$env:PATH"
          terraform init -input=false
          # Apply using the saved plan for change control, or comment and re-plan fresh:
          terraform apply -input=false -auto-approve tfplan

          # Outputs (optional)
          Write-Host "`n--- Terraform Outputs ---"
          terraform output || exit 0
