name: Terraform AIB Golden Image

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  id-token: write

env:
  TF_VERSION: "1.7.5"
  TF_WORKING_DIR: "."
  # Defaults (you can change these or pass via env/secrets/vars)
  # Use Azure short region names (lowercase, no spaces)
  DEFAULT_REPLICATION_REGIONS: "eastus,westeurope"
  DEFAULT_IMAGE_VERSION_MAJOR: "25"
  DEFAULT_AUTO_CLEANUP_AIB: "true"

jobs:
  plan:
    name: Validate & Plan
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          auth-type: SERVICE_PRINCIPAL

      # Export ARM_* env vars for the azurerm provider (parsed from AZURE_CREDENTIALS JSON)
      - name: Export ARM_* env for Terraform
        shell: pwsh
        run: |
          $c = '${{ secrets.AZURE_CREDENTIALS }}' | ConvertFrom-Json
          "ARM_CLIENT_ID=$($c.clientId)"           | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ARM_CLIENT_SECRET=$($c.clientSecret)"   | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ARM_TENANT_ID=$($c.tenantId)"           | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ARM_SUBSCRIPTION_ID=$($c.subscriptionId)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # Build TF_VAR_* so the module gets what it needs.
      # - replication_regions: convert "eastus,westeurope" -> ["eastus","westeurope"]
      # - image_version_major: integer-ish string
      # - auto_cleanup_aib: "true"/"false"
      # - force_rebuild_id: make every run trigger AIB (watched by replace_triggered_by)
      - name: Set Terraform variables (TF_VAR_*)
        shell: pwsh
        run: |
          $regions = '${{ env.DEFAULT_REPLICATION_REGIONS }}'.Split(',') | ForEach-Object { $_.Trim().ToLower() } | Where-Object { $_ -ne '' }
          $regionsJson = '["{0}"]' -f ($regions -join '","')
          "TF_VAR_replication_regions=$regionsJson" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          "TF_VAR_image_version_major=${{ env.DEFAULT_IMAGE_VERSION_MAJOR }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "TF_VAR_auto_cleanup_aib=${{ env.DEFAULT_AUTO_CLEANUP_AIB }}"       | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          # Force a rebuild on each workflow run
          "TF_VAR_force_rebuild_id=${{ github.run_id }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -upgrade -input=false

      - name: Terraform Validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      - name: Terraform Plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan -out=tfplan -input=false
          terraform show -no-color tfplan > tfplan.txt

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: |
            ${{ env.TF_WORKING_DIR }}/tfplan
            ${{ env.TF_WORKING_DIR }}/tfplan.txt

  apply:
    name: Apply (Build Image + Auto Cleanup)
    needs: plan
    runs-on: windows-latest
    environment:
      name: production
      url: https://portal.azure.com
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: .

      - name: Azure login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          auth-type: SERVICE_PRINCIPAL

      - name: Export ARM_* env for Terraform
        shell: pwsh
        run: |
          $c = '${{ secrets.AZURE_CREDENTIALS }}' | ConvertFrom-Json
          "ARM_CLIENT_ID=$($c.clientId)"           | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ARM_CLIENT_SECRET=$($c.clientSecret)"   | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ARM_TENANT_ID=$($c.tenantId)"           | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ARM_SUBSCRIPTION_ID=$($c.subscriptionId)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # Recreate the same TF_VAR_* values as plan job (they are baked into the plan)
      - name: Set Terraform variables (TF_VAR_*)
        shell: pwsh
        run: |
          $regions = '${{ env.DEFAULT_REPLICATION_REGIONS }}'.Split(',') | ForEach-Object { $_.Trim().ToLower() } | Where-Object { $_ -ne '' }
          $regionsJson = '["{0}"]' -f ($regions -join '","')
          "TF_VAR_replication_regions=$regionsJson" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          "TF_VAR_image_version_major=${{ env.DEFAULT_IMAGE_VERSION_MAJOR }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "TF_VAR_auto_cleanup_aib=${{ env.DEFAULT_AUTO_CLEANUP_AIB }}"       | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "TF_VAR_force_rebuild_id=${{ github.run_id }}"                      | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Apply (from saved plan)
        run: terraform apply -input=false -auto-approve tfplan

      - name: Terraform Outputs
        run: terraform output || exit 0
